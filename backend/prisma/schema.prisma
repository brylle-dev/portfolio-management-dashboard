generator client {
  provider = "prisma-client-js"
  // output   = "../src/lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum AssetClass {
  stock
  bond
  mutual_fund
}

enum TxnType {
  buy
  sell
}

enum UserStatus {
  active
  disabled
}

model User {
  id           String     @id @default(cuid())
  email        String     @unique
  passwordHash String
  username     String?    @unique
  fullName     String?
  status       UserStatus @default(active)
  createdAt    DateTime   @default(now()) @db.Timestamptz()
  updatedAt    DateTime   @updatedAt @db.Timestamptz()

  // relations
  refreshtokens RefreshToken[]
  portfolios    Portfolio[]
  auditLogs     AuditLog[]
}

model RefreshToken {
  id         String    @id @default(cuid())
  userId     String
  tokenHash  String
  deviceInfo String? // userAgent
  createdAt  DateTime  @default(now()) @db.Timestamptz()
  expiresAt  DateTime  @db.Timestamptz()
  revokedAt  DateTime? @db.Timestamptz()

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, tokenHash]) //uq_active_token
  @@index([userId])
}

model Portfolio {
  id           String   @id @default(cuid())
  userId       String
  name         String
  baseCurrency String   @db.Char(3)
  createdAt    DateTime @default(now()) @db.Timestamptz()
  updatedAt    DateTime @updatedAt @db.Timestamptz()

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // relations
  transactions Transaction[]
  positions    Position[]
  snapshots    PortfolioSnapshot[]

  @@index([userId])
  @@index([name])
}

model Instrument {
  id         String     @id @default(cuid())
  symbol     String     @unique
  name       String
  assetClass AssetClass
  currency   String     @db.Char(3)
  exchange   String?
  isin       String?
  cusip      String?
  active     Boolean    @default(true)

  createdAt DateTime @default(now()) @db.Timestamptz()
  updatedAt DateTime @updatedAt @db.Timestamptz()

  // relations
  prices       InstrumentPrice[]
  transactions Transaction[]
  positions    Position[]

  @@index([assetClass])
  @@index([active])
}

model InstrumentPrice {
  instrumentId String
  priceDate    DateTime @db.Date
  closePrice   Decimal  @db.Decimal(18, 6)
  source       String?

  instrument Instrument @relation(fields: [instrumentId], references: [id], onDelete: Cascade)

  @@id([instrumentId, priceDate]) //PK (instrument_id, price_date)
  @@index([priceDate])
}

model Transaction {
  id             String    @id @default(cuid())
  portfolioId    String
  instrumentId   String
  txnType        TxnType
  quantity       Decimal   @db.Decimal(20, 8)
  unitPrice      Decimal   @db.Decimal(18, 6)
  fees           Decimal   @default(0) @db.Decimal(18, 6)
  tradeDate      DateTime  @db.Date
  settlementDate DateTime? @db.Date
  notes          String?

  createdAt DateTime @default(now()) @db.Timestamptz()
  updatedAt DateTime @updatedAt @db.Timestamptz()

  //relations
  portfolio  Portfolio  @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  instrument Instrument @relation(fields: [instrumentId], references: [id])

  @@index([portfolioId, tradeDate])
  @@index([instrumentId, tradeDate])
  @@index([tradeDate])
}

model Position {
  id           String @id @default(cuid())
  portfolioId  String
  instrumentId String

  quantity      Decimal  @db.Decimal(20, 8)
  avgCost       Decimal  @db.Decimal(18, 6)
  lastMarkPrice Decimal? @db.Decimal(18, 6)
  marketValue   Decimal? @db.Decimal(18, 6)

  updatedAt DateTime @default(now()) @db.Timestamptz()

  portfolio  Portfolio  @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  instrument Instrument @relation(fields: [instrumentId], references: [id])

  @@unique([portfolioId, instrumentId]) // one position per instrument per portfolio
  @@index([portfolioId])
  @@index([instrumentId])
}

model PortfolioSnapshot {
  portfolioId   String
  snapshotDate  DateTime @db.Date
  marketValue   Decimal  @db.Decimal(18, 6)
  cashFlow      Decimal  @default(0) @db.Decimal(18, 6)
  realizePnl    Decimal  @default(0) @db.Decimal(18, 6)
  unrealizedPnl Decimal  @default(0) @db.Decimal(18, 6)

  portfolio Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)

  @@id([portfolioId, snapshotDate])
  @@index([snapshotDate])
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  entityType String
  entityId   String
  action     String
  oldValue   Json?
  newValue   Json?
  createdAt  DateTime @default(now()) @db.Timestamptz()

  user User? @relation(fields: [userId], references: [id])

  @@index([entityType, entityId])
  @@index([userId])
}
